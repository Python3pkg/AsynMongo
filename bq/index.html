<html>

	<head>
		<meta charset="utf-8">
		<title>python原生队列监控</title>
		<script type="text/javascript" src="http://cdn.hcharts.cn/jquery/jquery-1.8.3.min.js">
		</script>
		<script type="text/javascript" src="http://cdn.hcharts.cn/highcharts/highcharts.js">
		</script>
	</head>

	<body>
		<h1 style="text-align: center;">python原生队列监控</h1>
		<div id="control">
		</div>
		<div id="container" style="width:800px;height:400px;">
		</div>
		<script>
			$(function() {
				$(document).ready(function() {
					Highcharts.setOptions({
						global: {
							useUTC: false
						}
					});
					var y_value = 0;

					function get_y() {
						var name = $("input[name='control']:checked").val();
						$.getJSON("/qsize?name=" + name,
							function(json) {
								y_value = parseInt(json["qsize"]);
							});
						return y_value;
					};
					$('#container').highcharts({
						chart:{
							marginRight: 120
						},
						title: {
							text: '队列大小实时监控' //主标题
						},
						xAxis: { //X轴
							type: 'datetime',
							tickPixelInterval: 150
						},
						yAxis: { //Y轴
							title: {
								text: '数据量'
							},
							plotLines: [{
								value: 0,
								width: 1,
								color: '#808080'
							}]
						},
						tooltip: {
							backgroundColor: '#FCFFC5',
							borderColor: 'black',
    						borderRadius: 10,
							formatter: function() {
								return '<b>' + this.series.name + '</b><br>' + Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br>' + Highcharts.numberFormat(this.y, 2);
							}
						},
						legend: {
							align: 'right',
            				verticalAlign: 'top',
            				layout: "vertical",
            				floating: true,
            				x: 0,
            				y: 100
						},
						exporting: {
							enabled: false
						},
						credits: {
    					    enabled:false
						},
						series: []
					});
					var chart = $('#container').highcharts();

					function newCheck() {
						$.ajax({
							url: "/all_qsizes",
							dateType: "json",
							success: function(data) {
								json = eval(data);
								//获取全部的serie id
								var allSeriesId = new Array();
								$(chart.series).each(function(i, serie) {
									allSeriesId.push(serie.options.id);
								});

								var jsonName = new Array();
								for (var i = 0; i < json.length; i++) {
									jsonName.push(json[i]["name"])
									var name1 = json[i]["name"];
									var serie = chart.get(name1);
									var x = (new Date()).getTime();
									var y = json[i]["qsize"];
									if ($.inArray(name1, allSeriesId) != -1) { //更新已有的线
										serie.addPoint([x, y], false, true);
//										serie.removePoint(0, false);
									} else { //添加新的线
										chart.addSeries({
											name: name1,
											id: name1,
											data: (function() {
												var data = [];
												var	time = (new Date()).getTime();
												for (var i = -24; i <= 0; i++) {
													data.push({
														x: time + i * 1000,
														y: 0
													});
												}
												data[24][1] = y;
												return data;
											})()
										}, false);
									};
								};

								for (var i = 0; i < allSeriesId.length; i++){ //执行完的queue处理删除之
									if($.inArray(allSeriesId[i], jsonName) == -1){
										chart.get(allSeriesId[i]).remove(false);
									}
								}

								chart.redraw();
							}
						});
					};
					setInterval(newCheck, 1000);
				});
			});
		</script>
	</body>

</html>